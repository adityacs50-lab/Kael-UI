name: Build and Deploy KAEL UI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    steps:
    - uses: actions/checkout@v2
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-files
        path: dist/
        
  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Download build artifacts
      uses: actions/download-artifact@v2
      with:
        name: build-files
        path: dist/
        
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flask flask-cors requests
        
    - name: Create portable package
      run: |
        mkdir -p portable/dist
        cp -r dist/* portable/dist/
        cp standalone_server.py portable/
        cp DEPLOYMENT.md portable/README.md
        
        # Create launcher script
        echo '#!/bin/bash' > portable/start_kael.sh
        echo 'echo "Starting KAEL Standalone Server..."' >> portable/start_kael.sh
        echo 'python standalone_server.py' >> portable/start_kael.sh
        chmod +x portable/start_kael.sh
        
        # Create Windows launcher
        echo '@echo off' > portable/start_kael.bat
        echo 'echo Starting KAEL Standalone Server...' >> portable/start_kael.bat
        echo 'python standalone_server.py' >> portable/start_kael.bat
        
        # Create requirements file
        echo 'flask' > portable/requirements.txt
        echo 'flask-cors' >> portable/requirements.txt
        echo 'requests' >> portable/requirements.txt
        echo 'pyttsx3' >> portable/requirements.txt
        
        # Create setup scripts
        echo '#!/bin/bash' > portable/setup.sh
        echo 'echo "Installing required packages..."' >> portable/setup.sh
        echo 'pip install -r requirements.txt' >> portable/setup.sh
        echo 'echo "Setup complete! Run start_kael.sh to launch KAEL."' >> portable/setup.sh
        chmod +x portable/setup.sh
        
        echo '@echo off' > portable/setup.bat
        echo 'echo Installing required packages...' >> portable/setup.bat
        echo 'pip install -r requirements.txt' >> portable/setup.bat
        echo 'echo.' >> portable/setup.bat
        echo 'echo Setup complete! Run start_kael.bat to launch KAEL.' >> portable/setup.bat
        
        # Create zip archive
        zip -r kael-ui-portable.zip portable/
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./kael-ui-portable.zip
        asset_name: kael-ui-portable.zip
        asset_content_type: application/zip